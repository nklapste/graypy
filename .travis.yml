language: python

stages:
  - lint
  - test
  - build
# TODO: needs additional setup
#  - deploy

before_install:
  - pip install codecov

install:
  - pip install .

before_script:
  - cd tests/config
  - bash create_ssl_certs.sh -h localhost -i 127.0.0.1
  - cd ../..
  - docker-compose -f tests/config/docker-compose.yml down
  - docker-compose -f tests/config/docker-compose.yml up -d
  - sleep 40
  - "curl -u admin:admin 'http://127.0.0.1:9000/api/search/universal/relative?query=test&range=5&fields=message' || true"

script:
  - python setup.py test

after_script:
  - docker-compose -f tests/config/docker-compose.yml down

after_success:
  - codecov

jobs:
  include:
    - python: 2.7
    - python: 3.4
    - python: 3.5
    - python: 3.6
    - python: 3.7
      dist: xenial
    - python: "pypy2.7-5.10.0"
    - python: "pypy3.5-5.10.0"
    - stage: lint
      python:
        - 3.6
      before_script: skip
      after_script: skip
      script:
        - python setup.py lint || exit $(($? & 35))
    - stage: build
      name: "sdist"
      python:
        - 3.6
      before_script: skip
      script:
        - python setup.py sdist
      after_script: skip
    - name: "bdist_wheel"
      python:
        - 3.6
      install:
        - pip install . wheel
      before_script: skip
      script:
        - python setup.py bdist_wheel
      after_script: skip
    - stage: deploy
      deploy:
        python:
          - 3.6
        provider: pypi
        user: nklapste
        password:
          secure: ApbGgk15roR9k5tc8iwb9NLbTTXc3Gz34eAJOZ83NhH2EPwTPIU4KH8ZKsXznrUSYbYRWGJbkrClKCXsu2ZOOc9WkHfwwzZ/EnkW0G97Kd2QRz8oN6yDHcIrZw43Tz28HUGeov/ncFWJA7zxaNoYAVlNF6vvV7Zp5ytOsF65CuVXLPNRF9aNw0d7lM9KcneTQXzO+2pIINkoG7yYuDTUy/tuUKM5NDljRCdA6uHaulPgJrbgG7qJfKc7ouPbnjLlgcaENCnXtKqmB4TJ/3gkNL75Jhsp08YlJCdRKBP44gcs7Pg5rLbqJ2SNJQHdkzdJqIqjgq5+ewPVt+dtfi6+lO0+T6QPHcsxVIWM+lWe/vZh+N8qxdUogkSAQN9M3Rxnb/kaUENGa26IrvZMdzohV/43xZn3pJ4vzzMkQ+J1QJAJoNxmsjJLhGSRG73TUk9ViiuZEcGQFF78b3IwXeu46sWHvF/euONpMSdGIp3kLrj95w2TrsD9ulxuiGBxr2jL2nmQ5m4MC8KzRa+Xj+010gRnt7n+jeTlA4T6pGqVuaoLJorGrbX4/edhuGWDxLftRIDfwXq1PQU2c2Uiu+Ww1rn53Ttu3eKJ6DeG2F6Ymt8/R5KOIGLHhKmyHVjsy2agyYEQdGVNpJx0qcVkYxYlknC3E2UytSjSLO4vWsVY1bU=
        on:
          tags: true
          branch: master
          repo: severb/graypy
        distributions: "sdist bdist_wheel"
